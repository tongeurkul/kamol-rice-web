<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบบริหารจัดการโรงสีข้าว (Add Order Details)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b' }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom"
      }
    }
    </script>

    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, onSnapshot, 
            query, orderBy, getDocs, writeBatch, doc, serverTimestamp, runTransaction, Timestamp 
        } from 'firebase/firestore';
        
        import { 
            LayoutDashboard, Package, ShoppingCart, Users, Settings, Menu, X, Bell, Search, 
            TrendingUp, ArrowUpRight, ArrowDownRight, Truck, Factory, ClipboardList, 
            Plus, Save, Loader2, Database, Pencil, Trash2, Filter, AlertTriangle, AlertCircle, 
            Check, Printer, History, RefreshCcw, Info, KeyRound, Download, ChevronRight, LogOut,
            Cylinder, Clock, Tag, Layers, ArrowUpDown, MapPin, LayoutGrid, List, Box, FileText
        } from 'lucide-react';
        import { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend, AreaChart, Area
        } from 'recharts';

        // --- Firebase Config (rm-kamol) ---
        const firebaseConfig = {
            apiKey: "AIzaSyATgHULn71bBjjcx5WU_HJ5EUlvxyr5iy0",
            authDomain: "rm-kamol.firebaseapp.com",
            projectId: "rm-kamol",
            storageBucket: "rm-kamol.firebasestorage.app",
            messagingSenderId: "711522029752",
            appId: "1:711522029752:web:e7014219e5a4ca46a6a44d",
            measurementId: "G-PGYZQVSJFK"
        };

        // Initialize
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (err) { console.error("Firebase Init Error:", err); }

        const appId = 'kamol-rice-prod'; 
        const LOW_STOCK_THRESHOLD = 1000;
        const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ef4444', '#ec4899', '#6366f1'];

        // --- Helpers ---
        const parseNumber = (str) => {
            if (typeof str === 'number') return str;
            if (!str) return 0;
            return parseFloat(String(str).replace(/,/g, '').replace(/[^\d.-]/g, '')) || 0;
        };
        const formatCurrency = (num) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 }).format(num);
        const formatDate = (d) => {
            if (!d) return '-';
            let date = d instanceof Timestamp ? d.toDate() : new Date(d);
            return date.toLocaleDateString('th-TH', { year: '2-digit', month: 'short', day: 'numeric' });
        };
        const formatDateTime = (d) => {
            if (!d) return '-';
            let date = d instanceof Timestamp ? d.toDate() : new Date(d);
            return date.toLocaleDateString('th-TH', { year: '2-digit', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        };
        const getLocalISOString = () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        };
        const isDateInRange = (dateInput, startStr, endStr) => {
            if (!dateInput) return false;
            let date = dateInput instanceof Timestamp ? dateInput.toDate() : new Date(dateInput);
            const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            if (startStr && checkDate < new Date(startStr).setHours(0,0,0,0)) return false;
            if (endStr && checkDate > new Date(endStr).setHours(0,0,0,0)) return false;
            return true;
        };

        const downloadCSV = (data, filename) => {
            if (!data || !data.length) return alert("ไม่มีข้อมูลให้ดาวน์โหลด");
            const headers = Object.keys(data[0]).filter(k => !['id','createdAt','updatedAt'].includes(k));
            const csvRows = [headers.join(',')];
            for (const row of data) {
                const values = headers.map(header => {
                    const escaped = ('' + (row[header] || '')).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        };

        const printOrder = (order) => {
            const w = window.open('', '_blank');
            const qty = parseNumber(order.quantity);
            const amt = parseNumber(order.amount);
            w.document.write(`<html><head><title>ใบเสร็จ ${order.displayId}</title><style>body{font-family:sans-serif;padding:20px;}table{width:100%;border-collapse:collapse;margin:20px 0;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#f0f0f0;}.right{text-align:right;}</style></head><body><h2 style="text-align:center">ใบเสร็จรับเงิน / ใบส่งของ</h2><p><strong>เลขที่:</strong> ${order.displayId} <span style="float:right"><strong>วันที่:</strong> ${formatDate(order.date)}</span></p><p><strong>ลูกค้า:</strong> ${order.customer}</p><table><thead><tr><th>รายการ</th><th class="right">จำนวน</th><th class="right">ยอดเงิน</th></tr></thead><tbody><tr><td>${order.product}</td><td class="right">${qty.toLocaleString()}</td><td class="right">${amt.toLocaleString()}</td></tr></tbody><tfoot><tr><td colspan="2" class="right"><strong>รวมสุทธิ</strong></td><td class="right"><strong>${formatCurrency(amt)}</strong></td></tr></tfoot></table>
            <div style="margin-top:20px; font-size:14px; color:#555;"><strong>หมายเหตุ:</strong> ${order.details || '-'}</div>
            <div style="margin-top:50px;display:flex;justify-content:space-between;text-align:center;"><div>__________________<br>ผู้รับของ</div><div>__________________<br>ผู้ส่งของ</div></div><script>window.onload=()=>window.print();<\/script></body></html>`);
            w.document.close();
        };

        // --- Components ---
        const Toast = ({ msg, type, onClose }) => (
            <div className={`fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white z-[60] flex items-center gap-3 transition-all duration-300 transform translate-y-0 ${type==='err'?'bg-red-500':'bg-primary-600'}`}>
                {type==='err'?<AlertCircle size={20}/>:<Check size={20}/>}
                <span className="font-medium text-sm">{msg}</span>
                <button onClick={onClose}><X size={16} className="opacity-70 hover:opacity-100"/></button>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col scale-100 animate-in zoom-in-95 duration-200">
                        <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                            <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 bg-white p-1 rounded-full shadow-sm hover:shadow transition-all"><X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, trend, icon: Icon, color, isAlert }) => (
            <div className={`relative overflow-hidden bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 group`}>
                <div className={`absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity ${isAlert ? 'text-red-500' : 'text-primary-600'}`}>
                    <Icon size={80} />
                </div>
                <div className="flex items-center gap-4">
                    <div className={`p-3 rounded-xl ${isAlert ? 'bg-red-50 text-red-500' : 'bg-primary-50 text-primary-600'}`}>
                        <Icon size={24} />
                    </div>
                    <div>
                        <p className="text-sm font-medium text-gray-500">{title}</p>
                        <h3 className={`text-2xl font-bold mt-1 ${isAlert ? 'text-red-600' : 'text-gray-800'}`}>{value}</h3>
                    </div>
                </div>
            </div>
        );

        // --- Main App ---
        function App() {
            const [menu, setMenu] = useState('dashboard');
            const [user, setUser] = useState(null);
            const [data, setData] = useState({ orders:[], production:[], inventory:[], shipping:[], customers:[], logs:[], silos:[] });
            const [loading, setLoading] = useState(true);
            const [modal, setModal] = useState({ open:false, type:null, item:null });
            const [toast, setToast] = useState(null);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState(''); 
            
            // Filter & Sort States
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterCategory, setFilterCategory] = useState('all'); 
            const [sortOption, setSortOption] = useState('default'); 
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            
            // View Mode State (List or Grid)
            const [viewMode, setViewMode] = useState('list');

            const [salesTrendData, setSalesTrendData] = useState([]);
            const [productMixData, setProductMixData] = useState([]);

            useEffect(() => {
                signInAnonymously(auth).catch(e => console.error(e)); 
                return onAuthStateChanged(auth, u => setUser(u));
            }, []);

            useEffect(() => {
                if(!user) return;
                const refs = ['orders','production','inventory','shipping','customers','stockLogs','silos'].map(k => ({ key: k === 'stockLogs' ? 'logs' : k, q: query(collection(db, 'artifacts', appId, 'public', 'data', k), orderBy('createdAt', 'desc')) }));
                
                const checkAndSeedSilos = async () => {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'silos'));
                    const snap = await getDocs(q);
                    const existingNumbers = snap.docs.map(d => d.data().number);
                    const batch = writeBatch(db);
                    let needsCommit = false;
                    for(let i=1; i<=13; i++) {
                        if (!existingNumbers.includes(i)) {
                            const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'silos'));
                            batch.set(ref, { number: i, rice: '', amount: 0, capacity: 10000, createdAt: serverTimestamp() });
                            needsCommit = true;
                        }
                    }
                    // Seed Inventory Logic
                    const qInv = query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'));
                    const snapInv = await getDocs(qInv);
                    if (snapInv.empty) {
                        console.log("Seeding Real Inventory Data...");
                        const items = [
                            { code: 'A1', item: 'น.1', category: 'ข้าวสาร', stock: 11000, location: 'A1' },
                            { code: 'A2', item: 'น.1', category: 'ข้าวสาร', stock: 98000, location: 'A2' },
                            { code: 'A3', item: 'มะลิ B', category: 'ข้าวสาร', stock: 66000, location: 'A3' },
                            { code: 'B1', item: 'น.1 เหลือง', category: 'ข้าวสาร', stock: 31000, location: 'B1' },
                            { code: 'B2', item: 'หัก A', category: 'ข้าวหัก/ปลาย', stock: 32500, location: 'B2' },
                            { code: 'B3', item: 'วางพาเลต น.1 เหลือง', category: 'ข้าวสาร', stock: 0, location: 'B3' },
                            { code: 'B4/1', item: 'มะลิ A', category: 'ข้าวสาร', stock: 8000, location: 'B4/1' },
                            { code: 'B4/2', item: 'ข้าวไก่', category: 'Reject/อื่นๆ', stock: 0, location: 'B4/2' },
                            { code: 'B5', item: 'หักมะลิ A', category: 'ข้าวหัก/ปลาย', stock: 10000, location: 'B5' },
                            { code: 'B6', item: 'ปลาย น.', category: 'ข้าวหัก/ปลาย', stock: 45000, location: 'B6' },
                            { code: 'C1', item: 'น.1', category: 'ข้าวสาร', stock: 6000, location: 'C1' },
                            { code: 'C2', item: 'ข้าวไก่', category: 'Reject/อื่นๆ', stock: 36000, location: 'C2' },
                            { code: 'C3', item: 'กระสอบแพ็คแล้ว', category: 'ข้าวสาร', stock: 0, location: 'C3' },
                            { code: 'C4', item: 'หักมะลิ B', category: 'ข้าวหัก/ปลาย', stock: 41000, location: 'C4' },
                            { code: 'C5/1', item: 'หัก น.เหลือง', category: 'ข้าวหัก/ปลาย', stock: 43000, location: 'C5/1' },
                            { code: 'C5/2', item: 'หัก น.', category: 'ข้าวหัก/ปลาย', stock: 8000, location: 'C5/2' },
                            { code: 'C6', item: 'มะลิรวม', category: 'ข้าวสาร', stock: 95000, location: 'C6' },
                            { code: 'RJ-JAS-02', item: 'ข้าว Reject 2 (มะลิ)', category: 'Reject/อื่นๆ', stock: 0, location: 'รอระบุ' }
                        ];
                        items.forEach(it => {
                            const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'));
                            batch.set(ref, { ...it, displayId: `INV-${Math.floor(Math.random()*9000)+1000}`, createdAt: serverTimestamp() });
                        });
                        needsCommit = true;
                    }
                    if (needsCommit) await batch.commit();
                };
                checkAndSeedSilos();

                const unsubs = refs.map(({key, q}) => onSnapshot(q, snap => {
                    let items = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    if(key === 'silos') items = items.sort((a,b) => a.number - b.number);
                    if(key === 'inventory') {
                         items = items.sort((a,b) => {
                             if(!a.code) return 1; if(!b.code) return -1;
                             return a.code.localeCompare(b.code, undefined, {numeric: true, sensitivity: 'base'});
                         });
                    }
                    setData(prev => ({ ...prev, [key]: items }));
                    setLoading(false);
                }));
                return () => unsubs.forEach(u => u());
            }, [user]);

            useEffect(() => {
                if (!data.orders || !data.orders.length) {
                    setSalesTrendData([]);
                    setProductMixData([]);
                    return;
                }
                const trendMap = {}; 
                const months = [];
                for(let i=5; i>=0; i--){ 
                    const d=new Date(); d.setMonth(d.getMonth()-i); 
                    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; 
                    months.push({key:k, name: d.toLocaleDateString('th-TH',{month:'short'})}); 
                    trendMap[k]=0; 
                }
                data.orders.forEach(o => { if(o.status==='สำเร็จ') { const k = o.date ? o.date.substring(0,7) : ''; if(trendMap[k]!==undefined) trendMap[k]+=parseNumber(o.amount); }});
                setSalesTrendData(months.map(m=>({name:m.name, sales:trendMap[m.key]})));
                const mix={}; data.orders.forEach(o=>{ if(o.status==='สำเร็จ') mix[o.product]=(mix[o.product]||0)+parseNumber(o.amount) });
                setProductMixData(Object.keys(mix).map((k,i)=>({name:k, value:mix[k], color:COLORS[i%COLORS.length]})));
            }, [data.orders]);

            // Reset filters when menu changes
            useEffect(() => {
                setFilterStatus('all');
                setFilterCategory('all');
                setSortOption('default');
                setStartDate('');
                setEndDate('');
                setSearchTerm(''); 
            }, [menu]);

            // Handlers
            const handleSave = async (e) => {
                e.preventDefault(); const val = Object.fromEntries(new FormData(e.target).entries());
                setToast({ msg: 'กำลังบันทึก...', type: 'info' });
                try {
                    const colName = modal.type === 'logs' ? 'stockLogs' : modal.type; 
                    const isEdit = !!modal.item;
                    await runTransaction(db, async (t) => {
                        let finalData = { ...val, updatedAt: serverTimestamp() };
                        
                        if (modal.type === 'silo') {
                            finalData = { ...modal.item, ...val, updatedAt: serverTimestamp() }; 
                            t.update(doc(db, 'artifacts', appId, 'public', 'data', 'silos', modal.item.id), finalData);
                            return; 
                        }

                        if (!isEdit) {
                            finalData.createdAt = serverTimestamp();
                            const idSuffix = Math.floor(Math.random()*9000)+1000;
                            if (modal.type === 'orders') finalData.displayId = `#ORD-${idSuffix}`;
                            else if (modal.type === 'production') { finalData.displayId = `#P-${idSuffix}`; finalData.status = 'รอเริ่ม'; finalData.stockAdded = false; }
                            else if (modal.type === 'inventory') finalData.displayId = `#INV-${idSuffix}`;
                            else if (modal.type === 'shipping') { finalData.displayId = `#SHP-${idSuffix}`; finalData.status = 'กำลังส่ง'; }
                            else if (modal.type === 'customers') finalData.displayId = `#CUS-${idSuffix}`;
                        }
                        if (modal.type === 'orders') {
                            const invItem = data.inventory.find(i => i.item === val.product);
                            if (!invItem) throw new Error("ไม่พบสินค้านี้ในคลัง");
                            const invRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', invItem.id);
                            const invDoc = await t.get(invRef);
                            const currentStock = parseNumber(invDoc.data().stock);
                            const qty = parseNumber(val.quantity);
                            if (!isEdit && val.status !== 'ยกเลิก') {
                                if (currentStock < qty) throw new Error("สต็อกไม่พอ");
                                t.update(invRef, { stock: currentStock - qty });
                                finalData.stockDeducted = true;
                            }
                        }
                        if (modal.type === 'production' && isEdit && val.status === 'สำเร็จ' && !modal.item.stockAdded) {
                            const invItem = data.inventory.find(i => i.item === val.rice);
                            if (invItem) {
                                const invRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', invItem.id);
                                const invDoc = await t.get(invRef);
                                t.update(invRef, { stock: parseNumber(invDoc.data().stock) + parseNumber(val.amount) });
                                finalData.stockAdded = true;
                            }
                        }
                        if (isEdit) t.update(doc(db, 'artifacts', appId, 'public', 'data', colName, modal.item.id), finalData);
                        else t.set(doc(collection(db, 'artifacts', appId, 'public', 'data', colName)), finalData);
                    });
                    setModal({ open:false, type:null, item:null }); setToast({ msg: 'บันทึกสำเร็จ!', type: 'ok' }); setTimeout(() => setToast(null), 3000);
                } catch (err) { alert(err.message); setToast(null); }
            };

            const handleDelete = async (id, type) => {
                if(!confirm("ยืนยันการลบ?")) return;
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', type, id)); setToast({ msg: 'ลบแล้ว', type: 'ok' }); setTimeout(() => setToast(null), 3000); } catch(e) { alert(e.message); }
            };

            const lowStock = data.inventory.filter(i => parseNumber(i.stock) < LOW_STOCK_THRESHOLD);
            const sales = data.orders.filter(o => o.status === 'สำเร็จ').reduce((s, o) => s + parseNumber(o.amount), 0);

            const getFilteredData = (list) => {
                let res = [...list]; 

                if (searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    res = res.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(lowerTerm)));
                }
                
                if(filterStatus !== 'all') res = res.filter(i => (i.status || i.type) === filterStatus);
                
                if(startDate && endDate) {
                    const dateKey = menu === 'stockLogs' ? 'createdAt' : (menu === 'production' ? 'date' : 'date'); 
                    res = res.filter(i => isDateInRange(i[dateKey] || i.createdAt, startDate, endDate));
                }

                if (menu === 'inventory' && filterCategory !== 'all') {
                    res = res.filter(i => i.category === filterCategory);
                }

                if (menu === 'inventory' && sortOption !== 'default') {
                    res.sort((a, b) => {
                        if (sortOption === 'code') {
                            const valA = a.code || '';
                            const valB = b.code || '';
                            return valA.localeCompare(valB, undefined, {numeric: true, sensitivity: 'base'});
                        } else if (sortOption === 'location') {
                            const valA = a.location || '';
                            const valB = b.location || '';
                            return valA.localeCompare(valB, 'th', {numeric: true, sensitivity: 'base'}); 
                        } else if (sortOption === 'stock_desc') {
                            return parseNumber(b.stock) - parseNumber(a.stock);
                        } else if (sortOption === 'name') {
                            return a.item.localeCompare(b.item, 'th');
                        }
                        return 0;
                    });
                } else if (menu === 'inventory' && sortOption === 'default') {
                    res.sort((a, b) => {
                        const codeA = a.code || a.location || '';
                        const codeB = b.code || b.location || '';
                        return codeA.localeCompare(codeB, undefined, {numeric: true, sensitivity: 'base'});
                    });
                }

                return res;
            };

            // Modal Fields
            const getModalFields = () => {
                if(modal.type === 'orders') return [
                    {name:'date',type:'date',label:'วันที่'},
                    {name:'customer',label:'ลูกค้า'},
                    {name:'product',type:'select',label:'สินค้า',options:data.inventory.map(i=>({value:i.item,label:`${i.item} (${i.stock})`}))},
                    {name:'quantity',type:'number',label:'จำนวน'},
                    {name:'amount',type:'number',label:'ยอดเงิน'},
                    // Fixed: Added 'details' textarea field
                    {name:'details',type:'textarea',label:'รายละเอียดอื่นๆ',placeholder:'ระบุรายละเอียดเพิ่มเติม เช่น สถานที่ส่ง เบอร์โทร (ถ้ามี)'},
                    {name:'status',type:'select',label:'สถานะ',options:['รอดำเนินการ','กำลังส่ง','สำเร็จ','ยกเลิก']}
                ];
                
                if(modal.type === 'production') return [
                    {name:'startDateTime',type:'datetime-local',label:'เริ่มผลิต (วัน-เวลา)'},
                    {name:'endDateTime',type:'datetime-local',label:'สิ้นสุด (วัน-เวลา)'},
                    {name:'rice',type:'select',label:'สินค้า',options:data.inventory.map(i=>i.item)},
                    {name:'amount',type:'number',label:'จำนวน'},
                    {name:'stage',type:'select',label:'ขั้นตอน',options:['สีข้าว','คัดแยก','บรรจุ']},
                    {name:'status',type:'select',label:'สถานะ',options:['รอเริ่ม','กำลังผลิต','สำเร็จ']}
                ];
                
                if(modal.type === 'inventory') return [
                    {name:'code',label:'รหัสสินค้า/ตำแหน่ง',placeholder:'เช่น A1'},
                    {name:'item',label:'ชื่อสินค้า'},
                    {name:'category',type:'select',label:'หมวด',options:['ข้าวสาร','ข้าวเปลือก','ข้าวหัก/ปลาย','Reject/อื่นๆ']},
                    {name:'stock',type:'number',label:'คงเหลือ'},
                    {name:'location',label:'ที่เก็บ'}
                ];
                
                if(modal.type === 'customers') return [{name:'name',label:'ชื่อ'},{name:'phone',label:'โทร'},{name:'location',label:'ที่อยู่'}];
                
                if(modal.type === 'silo') return [
                    {name:'rice', label:`ข้าวในถัง (Silo ${modal.item.number})`, type:'text', placeholder:'เช่น ข้าวเปลือกหอมมะลิ (ว่างไว้ถ้าไม่มี)'},
                    {name:'amount', label:'ปริมาณปัจจุบัน (กก.)', type:'number'},
                    {name:'capacity', label:'ความจุถัง (กก.)', type:'number'}
                ];
                return [];
            };

            const menuItems = [
                {id:'dashboard',icon:LayoutDashboard,l:'ภาพรวม'},
                {id:'orders',icon:ClipboardList,l:'คำสั่งซื้อ'},
                {id:'production',icon:Factory,l:'การผลิต'},
                {id:'inventory',icon:Package,l:'คลังสินค้า'},
                {id:'customers',icon:Users,l:'ลูกค้า'},
                {id:'logs',icon:History,l:'ประวัติ'}
            ];

            const getColumns = (currentMenu) => {
                switch(currentMenu) {
                    case 'orders': return [{h:'วันที่',k:'date'},{h:'เลขที่',k:'displayId'},{h:'ลูกค้า',k:'customer'},{h:'สินค้า',k:'product'},{h:'จำนวน (กก.)',k:'quantity'},{h:'ยอดเงิน',k:'amount'},{h:'สถานะ',k:'status'}]; 
                    case 'inventory': return [
                        {h:'ตำแหน่ง/รหัส',k:'code'},
                        {h:'สินค้า',k:'item'},
                        {h:'หมวด',k:'category'},
                        {h:'คงเหลือ (กก.)',k:'stock'},
                        {h:'ที่เก็บ',k:'location'}
                    ];
                    case 'production': return [
                        {h:'เริ่ม',k:'startDateTime'},
                        {h:'สิ้นสุด',k:'endDateTime'},
                        {h:'สินค้า',k:'rice'},
                        {h:'จำนวน',k:'amount'},
                        {h:'สถานะ',k:'status'}
                    ];
                    case 'customers': return [{h:'ชื่อ',k:'name'},{h:'โทร',k:'phone'},{h:'ที่อยู่',k:'location'}];
                    default: return [{h:'เวลา',k:'createdAt'},{h:'สินค้า',k:'item'},{h:'ประเภท',k:'type'},{h:'จำนวน',k:'change'},{h:'สาเหตุ',k:'reason'}];
                }
            };

            // --- Card View Component ---
            const renderGrid = (list, type) => {
                return (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {list.map(item => {
                            const isLow = type==='inventory' && parseNumber(item.stock) < LOW_STOCK_THRESHOLD;
                            return (
                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between card-hover transition-all group">
                                    <div className="flex justify-between items-start mb-2">
                                        {type==='inventory' && <span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-md font-bold">{item.code || '-'}</span>}
                                        {type==='inventory' && <span className={`text-xs px-2 py-1 rounded-full ${item.category==='ข้าวสาร'?'bg-emerald-100 text-emerald-700':item.category==='ข้าวเปลือก'?'bg-yellow-100 text-yellow-700':'bg-blue-50 text-blue-700'}`}>{item.category}</span>}
                                        {type==='orders' && <span className="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded font-bold">{item.displayId}</span>}
                                        {type==='production' && <span className="bg-purple-50 text-purple-700 text-xs px-2 py-1 rounded font-bold">{item.displayId}</span>}
                                    </div>
                                    
                                    <div className="flex-1">
                                        {/* Customer is main title for orders */}
                                        <h3 className="font-bold text-gray-800 text-lg line-clamp-1">
                                            {type === 'orders' ? item.customer : (item.item || item.product || item.name || item.rice)}
                                        </h3>
                                        
                                        {type==='inventory' && (
                                            <div className="flex items-center gap-2 mt-2">
                                                <Box size={16} className="text-gray-400"/>
                                                <span className={`text-2xl font-bold ${isLow ? 'text-red-600':'text-gray-800'}`}>{parseNumber(item.stock).toLocaleString()}</span>
                                                <span className="text-xs text-gray-500 self-end mb-1">กก.</span>
                                            </div>
                                        )}
                                        {type==='orders' && (
                                            <div className="mt-1">
                                                <div className="text-sm text-gray-600">{item.product}</div>
                                                <div className="text-xl font-bold text-emerald-600 mt-1">{formatCurrency(parseNumber(item.amount))}</div>
                                                {item.details && <div className="text-xs text-gray-500 mt-2 p-2 bg-gray-50 rounded border border-gray-100 flex items-start gap-1"><FileText size={12} className="mt-0.5"/> <span className="line-clamp-2">{item.details}</span></div>}
                                            </div>
                                        )}
                                        {type==='production' && (
                                            <div className="mt-1">
                                                <div className="text-sm text-gray-600 flex items-center gap-1"><Clock size={14}/> {formatDateTime(item.startDateTime)}</div>
                                                <div className="text-xl font-bold text-blue-600 mt-1">{parseNumber(item.amount).toLocaleString()} กก.</div>
                                                <div className="text-xs text-gray-500 mt-1 bg-gray-100 inline-block px-2 py-0.5 rounded">{item.stage || 'ไม่ระบุ'}</div>
                                            </div>
                                        )}
                                        {type==='customers' && (
                                            <div className="mt-1 text-sm text-gray-600">
                                                <div className="flex items-center gap-1"><div className="w-4"><Users size={14}/></div> {item.phone}</div>
                                                <div className="flex items-center gap-1 mt-1"><div className="w-4"><MapPin size={14}/></div> <span className="truncate">{item.location}</span></div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="border-t border-gray-100 mt-4 pt-3 flex justify-between items-center">
                                        {type==='inventory' && <div className="text-xs text-gray-500 flex items-center gap-1"><MapPin size={12}/> {item.location}</div>}
                                        {type==='orders' && <div className="text-xs text-gray-400">{formatDate(item.date)}</div>}
                                        {type==='production' && (
                                             <span className={`px-2 py-0.5 rounded text-xs ${item.status==='สำเร็จ'?'bg-green-100 text-green-700':'bg-blue-50 text-blue-700'}`}>{item.status}</span>
                                        )}
                                        
                                        <div className="flex gap-1 ml-auto">
                                             {type==='orders' && <button onClick={()=>printOrder(item)} className="p-1.5 text-gray-400 hover:bg-gray-50 rounded-lg"><Printer size={14}/></button>}
                                             <button onClick={()=>setModal({open:true, type, item})} className="p-1.5 text-blue-500 hover:bg-blue-50 rounded-lg"><Pencil size={14}/></button>
                                             <button onClick={()=>handleDelete(item.id, type)} className="p-1.5 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={14}/></button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            const renderTable = (type, cols, list) => (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                        <thead className="bg-gray-50/50 border-b border-gray-100">
                            <tr>
                                {cols.map((c,i)=><th key={i} className="px-6 py-4 font-semibold text-gray-500">{c.h}</th>)}
                                {menu!=='logs' && <th className="px-6 py-4 text-right font-semibold text-gray-500">จัดการ</th>}
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50">
                            {list.length === 0 ? <tr><td colSpan={cols.length+1} className="p-8 text-center text-gray-400">ไม่มีข้อมูล</td></tr> :
                            list.map(item => (
                                <tr key={item.id} className="hover:bg-gray-50/80 transition-colors">
                                    {cols.map((c, i) => <td key={i} className="px-6 py-4 text-gray-700">{c.render ? c.render(item) : item[c.k]}</td>)}
                                    {menu!=='logs' && (
                                        <td className="px-6 py-4 text-right">
                                            <div className="flex items-center justify-end gap-1">
                                                {type==='orders' && <button onClick={()=>printOrder(item)} className="p-1.5 text-gray-400 hover:bg-gray-100 rounded-lg"><Printer size={16}/></button>}
                                                <button onClick={()=>setModal({open:true, type, item})} className="p-1.5 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"><Pencil size={16}/></button>
                                                <button onClick={()=>handleDelete(item.id, type)} className="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button>
                                            </div>
                                        </td>
                                    )}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );

            return (
                <div className="flex h-screen bg-gray-50 overflow-hidden font-sans">
                    {toast && <Toast msg={toast.msg} type={toast.type} onClose={()=>setToast(null)} />}
                    <Modal isOpen={modal.open} onClose={()=>setModal({open:false})} title={modal.item?(modal.type==='silo'?'แก้ไขสถานะไซโล':'แก้ไขรายการ'):'เพิ่มรายการใหม่'}>
                        <form onSubmit={handleSave} className="space-y-4">
                            {getModalFields().map(f => (
                                <div key={f.name}>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">{f.label}</label>
                                    {f.type==='select'?
                                    <div className="relative">
                                        <select name={f.name} className="w-full pl-3 pr-10 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all appearance-none" defaultValue={modal.item?.[f.name]}>
                                            {f.options.map(o=><option key={o.value||o} value={o.value||o}>{o.label||o}</option>)}
                                        </select>
                                        <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500"><ChevronRight size={16} className="rotate-90"/></div>
                                    </div>
                                    // Added Textarea logic
                                    :f.type==='textarea'?
                                    <textarea name={f.name} placeholder={f.placeholder} rows="3" className="w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all" defaultValue={modal.item?.[f.name]}></textarea>
                                    :<input name={f.name} type={f.type||'text'} placeholder={f.placeholder} className="w-full px-3 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all" defaultValue={modal.item?.[f.name]||(f.type==='datetime-local' && !modal.item?.[f.name] ? getLocalISOString() : (f.name==='date'?new Date().toISOString().split('T')[0]:''))}/>}
                                </div>
                            ))}
                            <button className="w-full bg-primary-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-primary-700 hover:shadow-xl transition-all mt-4 flex justify-center items-center gap-2">
                                <Save size={20} /> บันทึกข้อมูล
                            </button>
                        </form>
                    </Modal>

                    {/* Mobile Menu Overlay */}
                    {mobileMenuOpen && (
                        <div className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm" onClick={()=>setMobileMenuOpen(false)}></div>
                    )}

                    {/* Sidebar */}
                    <div className={`fixed lg:static inset-y-0 left-0 z-50 w-72 bg-white shadow-xl lg:shadow-none border-r border-gray-200 transform transition-transform duration-300 ease-in-out ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} flex flex-col`}>
                        <div className="h-20 flex items-center justify-center border-b border-gray-100">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-primary-100 text-primary-600 rounded-xl flex items-center justify-center font-bold text-xl shadow-sm">K</div>
                                <div>
                                    <h1 className="font-bold text-gray-800 text-lg leading-tight">กมลค้าข้าว</h1>
                                    <p className="text-xs text-gray-500">ระบบบริหารจัดการ</p>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 p-4 space-y-1 overflow-y-auto">
                            {menuItems.map(m => (
                                <button key={m.id} onClick={()=>{setMenu(m.id);setMobileMenuOpen(false)}} className={`w-full flex items-center p-3.5 rounded-xl transition-all duration-200 group ${menu===m.id ? 'bg-primary-50 text-primary-700 font-semibold shadow-sm' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}>
                                    <m.icon size={22} className={`mr-3 ${menu===m.id ? 'text-primary-600' : 'text-gray-400 group-hover:text-gray-600'}`} />
                                    {m.l}
                                    {menu===m.id && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-primary-500"></div>}
                                </button>
                            ))}
                        </div>
                        <div className="p-4 border-t border-gray-100">
                            <div className="bg-gray-50 p-3 rounded-xl flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400"><Users size={20}/></div>
                                <div>
                                    <p className="text-sm font-medium text-gray-800">ผู้ดูแลระบบ</p>
                                    <p className="text-xs text-green-600 flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ออนไลน์</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col h-full overflow-hidden relative">
                        {/* Header */}
                        <header className="h-20 bg-white/80 backdrop-blur-md border-b border-gray-200 flex justify-between items-center px-6 sticky top-0 z-30">
                            <div className="flex items-center gap-4">
                                <button onClick={()=>setMobileMenuOpen(true)} className="lg:hidden p-2 rounded-lg hover:bg-gray-100 text-gray-600"><Menu size={24}/></button>
                                <h2 className="text-2xl font-bold text-gray-800 capitalize hidden sm:block">{menuItems.find(m=>m.id===menu)?.l}</h2>
                            </div>

                             {menu !== 'dashboard' && (
                                <div className="flex-1 max-w-md mx-4 hidden md:block">
                                    <div className="relative">
                                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20}/>
                                        <input 
                                            type="text"
                                            placeholder="ค้นหา..." 
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2 bg-gray-100 border-none rounded-xl focus:ring-2 focus:ring-primary-500 outline-none transition-all"
                                        />
                                    </div>
                                </div>
                            )}

                            <div className="flex items-center gap-3">
                                {menu !== 'dashboard' && menu !== 'logs' && menu !== 'silos' && (
                                    <div className="bg-gray-100 rounded-lg p-1 flex items-center">
                                        <button onClick={()=>setViewMode('list')} className={`p-1.5 rounded-md transition-all ${viewMode==='list'?'bg-white shadow-sm text-primary-600':'text-gray-400 hover:text-gray-600'}`}><List size={18}/></button>
                                        <button onClick={()=>setViewMode('grid')} className={`p-1.5 rounded-md transition-all ${viewMode==='grid'?'bg-white shadow-sm text-primary-600':'text-gray-400 hover:text-gray-600'}`}><LayoutGrid size={18}/></button>
                                    </div>
                                )}

                                <button className="p-2.5 rounded-full hover:bg-gray-100 text-gray-500 relative">
                                    <Bell size={20}/>
                                    {lowStock.length > 0 && <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}
                                </button>
                                {menu!=='logs' && menu!=='dashboard' && menu!=='silos' && (
                                    <button onClick={()=>setModal({open:true, type:menu})} className="bg-primary-600 text-white px-4 py-2.5 rounded-xl shadow-lg shadow-primary-200 hover:shadow-xl hover:bg-primary-700 transition-all flex items-center gap-2 font-medium text-sm">
                                        <Plus size={18}/> <span className="hidden sm:inline">เพิ่มรายการ</span>
                                    </button>
                                )}
                            </div>
                        </header>

                        {/* Content */}
                        <main className="flex-1 p-4 lg:p-8 overflow-y-auto pb-24">
                            {menu === 'dashboard' ? (
                                <div className="space-y-6 max-w-7xl mx-auto">
                                    {/* ... Dashboard Cards ... */}
                                     {lowStock.length > 0 && (
                                        <div className="bg-red-50 border border-red-100 rounded-2xl p-4 flex items-start gap-4 animate-in slide-in-from-top-4">
                                            <div className="p-2 bg-white rounded-lg shadow-sm text-red-500"><AlertTriangle/></div>
                                            <div>
                                                <h3 className="font-bold text-red-800">สินค้าใกล้หมด ({lowStock.length})</h3>
                                                <div className="flex flex-wrap gap-2 mt-2">
                                                    {lowStock.map(i => <span key={i.id} className="text-xs bg-white px-2 py-1 rounded border border-red-100 text-red-600 font-medium">{i.item} ({parseNumber(i.stock)})</span>)}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <StatCard title="ยอดขายเดือนนี้" value={formatCurrency(sales)} icon={TrendingUp} />
                                        <StatCard title="คำสั่งซื้อรวม" value={data.orders.length} icon={ShoppingCart} />
                                        <StatCard title="สินค้าวิกฤต" value={lowStock.length} icon={AlertTriangle} isAlert={lowStock.length > 0} />
                                        <StatCard title="ลูกค้าทั้งหมด" value={data.customers.length} icon={Users} />
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                            <h3 className="font-bold text-gray-800 mb-4">แนวโน้มยอดขาย</h3>
                                            <div className="h-64"><ResponsiveContainer><AreaChart data={salesTrendData}><defs><linearGradient id="colorSales" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10b981" stopOpacity={0.1}/><stop offset="95%" stopColor="#10b981" stopOpacity={0}/></linearGradient></defs><XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize:12}}/><Tooltip contentStyle={{borderRadius:'12px', border:'none', boxShadow:'0 10px 15px -3px rgba(0, 0, 0, 0.1)'}}/><Area type="monotone" dataKey="sales" stroke="#10b981" strokeWidth={3} fillOpacity={1} fill="url(#colorSales)" /></AreaChart></ResponsiveContainer></div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                            <h3 className="font-bold text-gray-800 mb-4">สัดส่วนสินค้าขายดี</h3>
                                            <div className="h-64"><ResponsiveContainer><PieChart><Pie data={productMixData} dataKey="value" cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5}>{productMixData.map((e,i)=><Cell key={i} fill={e.color}/>)}</Pie><Tooltip contentStyle={{borderRadius:'12px', border:'none', boxShadow:'0 10px 15px -3px rgba(0, 0, 0, 0.1)'}}/><Legend/></PieChart></ResponsiveContainer></div>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="max-w-7xl mx-auto space-y-4">
                                    
                                    {/* Silo Visualization */}
                                    {menu === 'production' && data.silos.length > 0 && (
                                        <div className="mb-8 animate-in fade-in slide-in-from-top-2">
                                            <div className="flex items-center gap-2 mb-4 text-gray-700">
                                                <div className="p-2 bg-primary-100 text-primary-600 rounded-lg"><Cylinder size={24}/></div>
                                                <h3 className="font-bold text-lg">สถานะไซโล (Silo Status)</h3>
                                            </div>
                                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                                {data.silos.map(silo => {
                                                    const percent = Math.min((silo.amount / silo.capacity) * 100, 100);
                                                    return (
                                                        <div key={silo.id} onClick={()=>setModal({open:true, type:'silo', item:silo})} className="relative bg-white border border-gray-200 rounded-xl overflow-hidden h-44 cursor-pointer hover:shadow-lg transition-all group shadow-sm">
                                                            <div className="absolute bottom-0 left-0 right-0 bg-yellow-200/80 transition-all duration-700 ease-in-out border-t border-yellow-300" style={{height: `${percent}%`}}></div>
                                                            <div className="absolute inset-0 p-3 flex flex-col justify-between z-10">
                                                                <div className="flex justify-between items-start">
                                                                    <span className="text-xs font-bold text-gray-500 bg-white/90 px-2 py-1 rounded-md shadow-sm border border-gray-100">#{silo.number}</span>
                                                                    <Pencil size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity bg-white rounded-full p-0.5 shadow-sm"/>
                                                                </div>
                                                                <div className="text-center space-y-1">
                                                                    <div className="font-bold text-gray-800 text-sm truncate px-1">{silo.rice || '- ว่าง -'}</div>
                                                                    <div className="text-xs text-gray-600 font-medium bg-white/60 inline-block px-2 py-0.5 rounded-full backdrop-blur-sm">
                                                                        {parseNumber(silo.amount).toLocaleString()} / {parseNumber(silo.capacity/1000).toLocaleString()}k
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    {/* Filters */}
                                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 items-center justify-between">
                                        <div className="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                                            <Filter size={18} className="text-gray-400 min-w-[18px]"/>
                                            
                                            {menu === 'inventory' && (
                                                <>
                                                    <select value={filterCategory} onChange={e=>setFilterCategory(e.target.value)} className="bg-gray-50 border-0 rounded-lg text-sm py-2 pl-3 pr-8 focus:ring-2 focus:ring-primary-100 font-medium text-gray-600">
                                                        <option value="all">ทุกหมวดหมู่</option>
                                                        <option value="ข้าวเปลือก">ข้าวเปลือก</option>
                                                        <option value="ข้าวสาร">ข้าวสาร</option>
                                                        <option value="ข้าวหัก/ปลาย">ข้าวหัก/ปลาย</option>
                                                        <option value="Reject/อื่นๆ">Reject/อื่นๆ</option>
                                                    </select>
                                                    <div className="h-6 w-px bg-gray-200 mx-1"></div>
                                                </>
                                            )}
                                            
                                            {menu === 'inventory' && (
                                                <>
                                                    <select value={sortOption} onChange={e=>setSortOption(e.target.value)} className="bg-gray-50 border-0 rounded-lg text-sm py-2 pl-3 pr-8 focus:ring-2 focus:ring-primary-100 font-medium text-gray-600">
                                                        <option value="default">เรียงตาม: ค่าเริ่มต้น</option>
                                                        <option value="code">🏷️ เรียงตามรหัส (Code)</option>
                                                        <option value="location">📍 เรียงตามที่เก็บ (Location)</option>
                                                        <option value="stock_desc">📉 เรียงตามคงเหลือ (มาก-น้อย)</option>
                                                        <option value="name">📝 เรียงตามชื่อ (ก-ฮ)</option>
                                                    </select>
                                                    <div className="h-6 w-px bg-gray-200 mx-1"></div>
                                                </>
                                            )}

                                            {['orders', 'production'].includes(menu) && (
                                                <select value={filterStatus} onChange={e=>setFilterStatus(e.target.value)} className="bg-gray-50 border-0 rounded-lg text-sm py-2 pl-3 pr-8 focus:ring-2 focus:ring-primary-100 font-medium text-gray-600">
                                                    <option value="all">สถานะทั้งหมด</option>
                                                    {['สำเร็จ','กำลังส่ง','กำลังผลิต','รอเริ่ม','IN','OUT'].map(s=><option key={s} value={s}>{s}</option>)}
                                                </select>
                                            )}

                                            <div className="hidden md:block h-6 w-px bg-gray-200 mx-2"></div>
                                            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="bg-gray-50 border-0 rounded-lg text-sm py-2 px-3 focus:ring-2 focus:ring-primary-100 text-gray-600"/>
                                            <span className="text-gray-300">-</span>
                                            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="bg-gray-50 border-0 rounded-lg text-sm py-2 px-3 focus:ring-2 focus:ring-primary-100 text-gray-600"/>
                                        </div>
                                        <div className="flex gap-2 w-full md:w-auto">
                                            <button onClick={()=>downloadCSV(getFilteredData(data[menu==='stockLogs'?'logs':menu]), menu)} className="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 rounded-lg text-sm font-medium transition-colors"><Download size={16}/> Export</button>
                                            <button onClick={()=>{setFilterStatus('all');setFilterCategory('all');setSortOption('default');setStartDate('');setEndDate('');setSearchTerm('')}} className="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 text-gray-500 hover:bg-gray-50 rounded-lg text-sm font-medium transition-colors border border-gray-200"><RefreshCcw size={16}/> Reset</button>
                                        </div>
                                    </div>

                                    {/* Display Area (Switch between List and Grid) */}
                                    {viewMode === 'list' ? renderTable(menu, 
                                        getColumns(menu),
                                        getFilteredData(data[menu==='stockLogs'?'logs':menu])
                                    ) : (
                                        renderGrid(getFilteredData(data[menu==='stockLogs'?'logs':menu]), menu)
                                    )}

                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
